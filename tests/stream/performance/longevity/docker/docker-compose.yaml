version: "3.7"
services:
  proton-server:
    image: ghcr.io/timeplus-io/proton:${PROTON_VERSION:-develop}
    pull_policy: always
    container_name: proton-server
    volumes:
     - ../proton-server/datas:/var/lib/proton
     - ../proton-server/log:/var/log/proton-server
    ports:
      - "3218:3218" #  HTTP
      - "8463:8463" # TCP
      - "5432:5432" # Postgres
      - "9004:9004" # MySQL
      - "7587:7587" # table mode
    deploy:
      replicas: 1
      #restart_policy:
      #  condition: on-failure
    # `proton` depends on STREAM_STORAGE_BROKERS env variable
    # to discover stream store
    environment:
      - STREAM_STORAGE_BROKERS=stream-store:9092
      - MAX_CONCURRENT_QUERIES=10000        # Default: 100
      - MAX_CONCURRENT_SELECT_QUERIES=5000     # Default: 100
      - MAX_CONCURRENT_INSERT_QUERIES=5000     # Default: 100
      - MAX_CONCURRENT_STREAMING_QUERIES=5000   # Default: 100
      - MAX_SERVER_MEMORY_USAGE_TO_RAM_RATIO=0.8 # Default: 0.0
      - MAX_SERVER_MEMORY_CACHE_TO_RAM_RATIO=0.2 # Default: 0.5      
    command: >
      /bin/bash -c "echo sleeping; sleep 2; /entrypoint.sh"


