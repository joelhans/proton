version: "3.7"

# this is an extension field, its name must start with `x-`
x-logging: &default-logging
  driver: local
  options: # https://docs.docker.com/config/containers/logging/local/#options
    max-size: "20m"
    max-file: "5"
    compress: "true"

services:

  proton-server:
    image: ghcr.io/timeplus-io/proton:${PROTON_VERSION:-develop}
    logging: *default-logging
    extra_hosts: 
        - "kafka:${KAFKA_IP}"      
    pull_policy: always
    container_name: proton-server
    volumes:
      - ./proton-server/datas:/var/lib/proton
      - ./proton-server/log:/var/log/proton-server
      - ./data:/timeplus/data
    ports:
      - "13218:3218" # HTTP Streaming
      - "18123:8123" # HTTP Snapshot
      - "18463:8463" # TCP Streaming
      - "17587:7587" # TCP Snapshot
      - "9444:9444" # KV port

    deploy:
      replicas: 1

    # `proton` depends on STREAM_STORAGE_BROKERS env variable
    # to discover stream store
    environment:
      - MAX_CONCURRENT_QUERIES=100        # Default: 100
      - MAX_CONCURRENT_SELECT_QUERIES=100     # Default: 100
      - MAX_CONCURRENT_INSERT_QUERIES=100     # Default: 100
      - MAX_CONCURRENT_STREAMING_QUERIES=100   # Default: 100
      - MAX_SERVER_MEMORY_USAGE_TO_RAM_RATIO=0.9 # Default: 0.9
      - MAX_SERVER_MEMORY_CACHE_TO_RAM_RATIO=0.5 # Default: 0.5
      - STREAM_STORAGE_BROKERS=kafka:29092
      - LOGSTORE_REPLICATION_FACTOR=3
      - STREAM_STORAGE_TYPE=kafka
      - STREAM_STORAGE_CLUSTER_ID=kafkacluster

    command: >
      /bin/bash -c "echo sleeping; sleep 2; /entrypoint.sh"

networks:
  default:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: "192.168.12.0/24"
