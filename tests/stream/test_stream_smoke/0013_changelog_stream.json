{
    "test_suite_name": "changelog_stream",
    "tag": "smoke",

    "test_suite_config":{
        "setup": {
            "statements": [
                {"client":"python", "query_type": "table","wait":1, "query":"drop stream if exists changelog_stream"},
                {"client":"python", "query_type": "table", "wait":2, "query":"create stream if not exists changelog_stream(i int) settings mode='changelog'"},
                {"client":"python", "query_type": "table","wait":1, "query":"drop stream if exists test14_changelog_kv_stream"},
                {"client":"python", "query_type": "table", "wait":2, "query":"create stream if not exists test14_changelog_kv_stream(i int, s string) primary key s settings mode='changelog_kv'"}
            ]
        },    
        "tests_2_run": {"ids_2_run": ["all"], "tags_2_run":[], "tags_2_skip":{"default":["todo", "to_support", "change", "bug", "sample", "native_not_support"],"cluster": ["view", "cluster_table_bug"]}}
    },
    "comments": "Tests covering the single shard changelog stream query smoke cases.",
    "tests": [
        {
            "id": 0,
            "tags": ["changelog_stream"],
            "name": "single shard changelog stream",
            "description": "single shard changelog stream creation and query",
            "steps":[
                {
                    "statements": [
            {"client":"python","query_id":"1400", "depends_on_stream":"changelog_stream","query_end_timer":7, "query_type": "stream", "query":"select i, _tp_delta from changelog_stream;"},
            {"client":"python", "query_type": "table","depends_on":1400, "wait":2, "query": "insert into changelog_stream(i) values (1)"},
            {"client":"python", "query_type": "table", "wait":1, "query": "insert into changelog_stream(i, _tp_delta) values (1, -1)"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1400",
                    "expected_results":[
                        [1, 1], [1, -1]
                    ]
                }
            ]
        },
        {
            "id": 1,
            "tags": ["test14_changelog_kv_stream"],
            "name": "single shard changelog_kv stream",
            "description": "single shard changelog_kv stream creation and query",
            "steps":[
                {
                    "statements": [
            {"client":"python", "query_type": "table", "wait":1,"depends_on_stream":"test14_changelog_kv_stream", "query": "insert into test14_changelog_kv_stream(i, s) values (1, 'a')"},
            {"client":"python", "query_type": "table", "wait":1,"depends_on_stream":"test14_changelog_kv_stream", "query": "insert into test14_changelog_kv_stream(i, s) values (2, 'b')"},
            {"client":"python", "query_type": "table", "wait":1,"depends_on_stream":"test14_changelog_kv_stream", "query": "insert into test14_changelog_kv_stream(i, s, _tp_delta) values (1, 'a', -1), (2, 'b', -1), (3, 'b', 1), (4, 'c', 1)"},
            {"client":"python","query_id":"1401", "wait":2, "depends_on_stream":"test14_changelog_kv_stream","query_end_timer":10, "query_type": "stream", "query":"select i, s, _tp_delta from test14_changelog_kv_stream;"},
            {"client":"python", "query_type": "table", "depends_on":1401, "wait":1,"depends_on_stream":"test14_changelog_kv_stream", "query": "insert into test14_changelog_kv_stream(i, s) values (5, 'd')"},
            {"client":"python", "query_type": "table", "wait":2,"depends_on_stream":"test14_changelog_kv_stream", "query": "insert into test14_changelog_kv_stream(i, s, _tp_delta) values (4, 'c', -1)"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1401",
                    "expected_results":[
                        [3, "b", 1], [4, "c", 1], [5, "d", 1], [4, "c", -1]
                    ]
                }
            ]
        },
        {
            "id": 2,
            "tags": ["changelog_stream"],
            "name": "single shard changelog stream via rest",
            "description": "single shard changelog stream creation via rest",
            "steps":[
                {
                    "statements": [
                        {"client":"python", "query_type": "table","wait":1, "query":"drop stream if exists changelog_stream_rest"},
                        {"client":"rest", "query_type": "table", "wait": 2, "rest_type": "raw", "query_url":"/proton/v1/ddl/streams", "query_id": 1402,"http_method": "POST",
                        "data" : {"name": "changelog_stream_rest", "columns": [{"name": "i", "type": "int"}], "mode": "changelog"}}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1402",
                    "expected_results": {"request_id": "1402"}
                }
            ]
        },
        {
            "id": 3,
            "tags": ["changelog_stream"],
            "name": "single shard changelog_kv stream via rest",
            "description": "single shard changelog_kv stream creation via rest",
            "steps":[
                {
                    "statements": [
            {"client":"python", "query_type": "table","wait":1, "query":"drop stream if exists test14_changelog_kv_stream_rest"},
                        {"client":"rest", "query_type": "table", "wait": 2, "rest_type": "raw", "query_url":"/proton/v1/ddl/streams", "query_id": 1403,"http_method": "POST",
              "data" : {"name": "test14_changelog_kv_stream_rest", "columns": [{"name": "i", "type": "int"}, {"name": "k", "type": "string"}], "mode": "changelog_kv", "primary_key": "k"}}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1403",
                    "expected_results": {"request_id": "1403"}
                }
            ]
        },
        {
            "id": 4,
            "tags": ["changelog_kv_aggr"],
            "name": "aggr_func_count_and_sum_changelog_kv",
            "description": "aggregation function count and sum changelog_kv",
            "steps":[
                {
                    "statements": [
                        {"client":"python", "query_type": "table", "query":"drop stream if exists test14_changelog_kv_stream"},
                        {"client":"python", "query_type": "table", "exist":"test14_changelog_kv_stream", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_changelog_kv_stream(id int, val float) primary key id settings mode='changelog_kv'"}, 
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_changelog_kv_stream(id, val) values (1, 1.1), (2, 2.2), (3, 3.3)"},
                        {"client":"python", "query_type": "stream", "query_id":"1404", "depends_on_stream":"test14_changelog_kv_stream", "wait":1, "terminate":"manual", "query":"select count(val), min(val), max(val), sum(val), avg(val) from test14_changelog_kv_stream emit periodic 1s"},
                        {"client":"python", "query_type": "table", "depends_on":"1404", "wait":1, "query": "insert into test14_changelog_kv_stream(id, val) values (4, 4.4), (5, 5.5)"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_changelog_kv_stream(id, val, _tp_delta) values (3, 3.3, -1)"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_changelog_kv_stream(id, val, _tp_delta) values (1, 1.1, -1)"},
                        {"client":"python", "query_type": "table", "kill":"1404", "kill_wait":3, "wait":1, "query": "insert into test14_changelog_kv_stream(id, val, _tp_delta) values (5, 5.5, -1)"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1404",
                    "expected_results":[
                        ["3", "1.1", "3.3", "6.6", "2.2"],
                        ["5", "1.1", "5.5", "16.5", "3.3"],
                        ["4", "1.1", "5.5", "14.2", "3.3"],
                        ["3", "2.2", "5.5", "12.1", "4.0333333"],
                        ["2", "2.2", "4.4", "6.6", "3.3"]
                    ]
                }
            ]
        },
        {
            "id": 5,
            "tags": ["changelog_kv_aggr", "native_not_support", "bug"],
            "name": "aggr_func_count_distinct_and_count_if_changelog_kv",
            "description": "aggregation function count_distinct and count_if changelog_kv",
            "steps":[
                {
                    "statements": [
                    {"client":"python", "query_type": "table", "query":"drop stream if exists test14_changelog_kv_stream"},
                    {"client":"python", "query_type": "table", "exist":"test14_changelog_kv_stream", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_changelog_kv_stream(id int, val float) primary key id settings mode='changelog_kv'"}, 
                    {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_changelog_kv_stream(id, val) values (1, 1.1), (2, 2.2), (3, 3.3)"},
                    {"client":"python", "query_type": "stream", "query_id":"1405", "depends_on_stream":"test14_changelog_kv_stream", "wait":1, "terminate":"manual", "query":"select count(1), count_distinct(val), count_if(val > 2) from test14_changelog_kv_stream emit periodic 1s"},
                    {"client":"python", "query_type": "table", "depends_on":"1405", "wait":1, "query": "insert into test14_changelog_kv_stream(id, val) values (4, 4.4), (5, 5.5)"},
                    {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_changelog_kv_stream(id, _tp_delta) values (3, -1)"},
                    {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_changelog_kv_stream(id, _tp_delta) values (1, -1)"},
                    {"client":"python", "query_type": "table", "kill":"1405", "kill_wait":3, "wait":1, "query": "insert into test14_changelog_kv_stream(id, _tp_delta) values (5, -1)"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1405",
                    "expected_results":[
                        ["3", "3", "2"],
                        ["5", "5", "4"],
                        ["4", "4", "3"],
                        ["3", "3", "3"],
                        ["2", "2", "2"]
                    ]
                }
            ]
        },
        {
            "id": 6,
            "tags": ["changelog_kv_aggr", "native_not_support", "bug"],
            "name": "aggr_func_unique_exact_and_unique_exact_changelog_kv",
            "description": "aggregation function unique_exact and unique_exact changelog_kv",
            "steps":[
                {
                    "statements": [
                    {"client":"python", "query_type": "table", "query":"drop stream if exists test14_changelog_kv_stream"},
                    {"client":"python", "query_type": "table", "exist":"test14_changelog_kv_stream", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_changelog_kv_stream(id int, val float) primary key id settings mode='changelog_kv'"}, 
                    {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_changelog_kv_stream(id, val) values (1, 1.1), (2, 2.2), (3, 3.3)"},
                    {"client":"python", "query_type": "stream", "query_id":"1406", "depends_on_stream":"test14_changelog_kv_stream", "wait":1, "terminate":"manual", "query":"select unique(id), unique_exact(val), unique_exact_if(val > 2) from test14_changelog_kv_stream emit periodic 1s"},
                    {"client":"python", "query_type": "table", "depends_on":"1406", "wait":1, "query": "insert into test14_changelog_kv_stream(id, val) values (4, 4.4), (5, 5.5)"},
                    {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_changelog_kv_stream(id, _tp_delta) values (2, -1)"},
                    {"client":"python", "query_type": "table", "kill":"1406", "kill_wait":3, "wait":1, "query": "insert into test14_changelog_kv_stream(id, _tp_delta) values (3, -1)"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1406",
                    "expected_results":[
                        ["3", "2", "1"],
                        ["5", "3", "2"],
                        ["4", "3", "2"],
                        ["3", "2", "1"]
                    ]
                }
            ]
        },
        {
            "id": 7,
            "tags": ["changelog_kv_aggr", "native_not_support", "bug"],
            "name": "aggr_func_median_and_quantile_changelog_kv",
            "description": "aggregation function median and quantile changelog_kv",
            "steps":[
                {
                    "statements": [
                    {"client":"python", "query_type": "table", "query":"drop stream if exists test14_changelog_kv_stream"},
                    {"client":"python", "query_type": "table", "exist":"test14_changelog_kv_stream", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_changelog_kv_stream(id int, val float) primary key id settings mode='changelog_kv'"}, 
                    {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_changelog_kv_stream(id, val) values (1, 1.1), (2, 2.2), (3, 3.3)"},
                    {"client":"python", "query_type": "stream", "query_id":"1407", "depends_on_stream":"test14_changelog_kv_stream", "wait":1, "terminate":"manual", "query":"select median(val), quantile(val, 0.5) from test14_changelog_kv_stream emit periodic 1s"},
                    {"client":"python", "query_type": "table", "depends_on":"1407", "wait":1, "query": "insert into test14_changelog_kv_stream(id, val) values (4, 4.4), (5, 5.5)"},
                    {"client":"python", "query_type": "table", "kill":"1407", "kill_wait":3, "wait":1, "query": "insert into test14_changelog_kv_stream(id, _tp_delta) values (2, -1) (3, -1)"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1407",
                    "expected_results":[
                        ["2.2", "2.2"],
                        ["3.3", "3.3"],
                        ["4.4", "4.4"]
                    ]
                }
            ]
        },
        {
            "id": 8,
            "tags": ["changelog_kv_aggr", "native_not_support", "bug"],
            "name": "aggr_func_top_k_changelog_kv",
            "description": "aggregation function top_k changelog_kv",
            "steps":[
                {
                    "statements": [
                    {"client":"python", "query_type": "table", "query":"drop stream if exists test14_changelog_kv_stream"},
                    {"client":"python", "query_type": "table", "exist":"test14_changelog_kv_stream", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_changelog_kv_stream(id int, val float) primary key id settings mode='changelog_kv'"}, 
                    {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_changelog_kv_stream(id, val) values (1, 1.1), (1, 2.2), (3, 3.3)"},
                    {"client":"python", "query_type": "stream", "query_id":"1408", "depends_on_stream":"test14_changelog_kv_stream", "wait":1, "terminate":"manual", "query":"select top_k(id, 2) from test14_changelog_kv_stream emit periodic 1s"},
                    {"client":"python", "query_type": "table", "depends_on":"1408", "wait":1, "query": "insert into test14_changelog_kv_stream(id, val) values (4, 4.4), (4, 5.5)"},
                    {"client":"python", "query_type": "table", "kill":"1408", "kill_wait":3, "wait":1, "query": "insert into test14_changelog_kv_stream(id, _tp_delta) values (1, -1)"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1408",
                    "expected_results":[
                        ["(1, 2),(3, 1)"],
                        ["(1, 2),(4, 2)"],
                        ["(4, 2),(3, 1)"]
                    ]
                }
            ]
        },
        {
            "id": 9,
            "tags": ["changelog_kv_aggr", "native_not_support", "bug"],
            "name": "aggr_func_min_k_and_max_k_changelog_kv",
            "description": "aggregation function min_k and max_k changelog_kv",
            "steps":[
                {
                    "statements": [
                    {"client":"python", "query_type": "table", "query":"drop stream if exists test14_changelog_kv_stream"},
                    {"client":"python", "query_type": "table", "exist":"test14_changelog_kv_stream", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_changelog_kv_stream(id int, val float) primary key id settings mode='changelog_kv'"}, 
                    {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_changelog_kv_stream(id, val) values (1, 1.1), (1, 2.2), (3, 3.3)"},
                    {"client":"python", "query_type": "stream", "query_id":"1409", "depends_on_stream":"test14_changelog_kv_stream", "wait":1, "terminate":"manual", "query":"select min_k(val, 2, id), max_k(val, 2, id) from test14_changelog_kv_stream emit periodic 1s"},
                    {"client":"python", "query_type": "table", "depends_on":"1409", "wait":1, "query": "insert into test14_changelog_kv_stream(id, val) values (4, 4.4), (4, 5.5)"},
                    {"client":"python", "query_type": "table", "kill":"1409", "kill_wait":3, "wait":1, "query": "insert into test14_changelog_kv_stream(id, _tp_delta) values (1, -1) (5, -1)"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1409",
                    "expected_results":[
                        [["(1.1, 1), (2.2, 2)"], ["(3.3, 3), (2.2, 2)"]],
                        [["(1.1, 1), (2.2, 2)"], ["(5.5, 5), (4.4, 4)"]],
                        [["(2.2, 2), (3.3, 3)"], ["(4.4, 4), (3.3, 3)"]]
                    ]
                }
            ]
        },
        {
            "id": 10,
            "tags": ["changelog_kv", "bidirectional-join"],
            "name": "changelog-kv_inner_join_changelog-kv",
            "description": "changelog-kv inner all join changelog-kv",
            "steps":[
                {
                    "statements": [
                        {"client":"python", "query_type": "table", "query":"drop stream if exists changelog_kv_stream1"},
                        {"client":"python", "query_type": "table", "query":"drop stream if exists changelog_kv_stream2"},
                        {"client":"python", "query_type": "table", "exist":"changelog_kv_stream1", "exist_wait":2, "wait":1, "query":"create stream if not exists changelog_kv_stream1(i int, s string) primary key s settings mode='changelog_kv'"}, 
                        {"client":"python", "query_type": "table", "exist":"changelog_kv_stream2", "exist_wait":2, "wait":1, "query":"create stream if not exists changelog_kv_stream2(ii int, ss string) primary key ss settings mode='changelog_kv'"}, 
                        {"client":"python", "query_type": "stream", "query_id":"1410", "wait":1, "terminate":"manual", "query":"select i, s, ii, ss, _tp_delta from changelog_kv_stream1 inner join changelog_kv_stream2 on i == ii"},
                        {"client":"python", "query_type": "table", "depends_on":"1410", "wait":1, "query": "insert into changelog_kv_stream1 (i, s) values (1, 's1')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into changelog_kv_stream2 (ii, ss) values (1, 'ss1')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into changelog_kv_stream1 (i, s) values (1, 's2')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into changelog_kv_stream1 (i, s, _tp_delta) values (1, 's1', -1)"},
                        {"client":"python", "query_type": "table", "kill":"1410", "kill_wait":3, "wait":1, "query": "insert into changelog_kv_stream2 (ii, ss) values (1, 'ss2')"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1410",
                    "expected_results":[
                        [1, "s1", 1, "ss1", 1],
                        [1, "s2", 1, "ss1", 1],
                        [1, "s1", 1, "ss1", 1],
                        [1, "s2", 1, "ss2", 1]
                    ]
                }
            ]
        },
        {
            "id": 11,
            "tags": ["changelog(table)", "bidirectional-join"],
            "name": "changelog(table) Inner all join changelog(table)(all primary keys join)",
            "description": "changelog(table) Inner all join changelog(table)(all primary keys join)",
            "steps": [
                {
                    "statements": [
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_append_stream1"},
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_append_stream2"},
                        {"client":"python", "query_type": "table", "exist":"test14_append_stream1", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_append_stream1(i int, k1 int, k2 string)"},
                        {"client":"python", "query_type": "table", "exist":"test14_append_stream2", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_append_stream2(j int, kk1 int, kk2 string)"},
                        {"client":"python", "query_type": "stream", "query_id":"1411", "wait":1, "terminate":"manual", "query":"select a.i, a.k1, a.k2, b.j, b.kk1, b.kk2, _tp_delta from changelog(test14_append_stream1, k1, k2) as a inner all join changelog(test14_append_stream2, kk1, kk2) as b on a.k1 = b.kk1 and a.k2 = b.kk2"},
                        {"client":"python", "query_type": "table", "depends_on":"1411", "wait":1, "query": "insert into test14_append_stream1(i, k1, k2) values (1, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream2(j, kk1, kk2) values (2, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream1(i, k1, k2) values (3, 1, 'k')"},
                        {"client":"python", "query_type": "table", "kill":"1411", "kill_wait":3, "wait":1, "query": "insert into test14_append_stream2(j, kk1, kk2) values (4, 1, 'k')"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1411",
                    "expected_results":[
                        [1, 1, "k", 2, 1, "k", 1],
                        [1, 1, "k", 2, 1, "k", -1],
                        [3, 1, "k", 2, 1, "k", 1],
                        [3, 1, "k", 2, 1, "k", -1],
                        [3, 1, "k", 4, 1, "k", 1]
                    ]
                }
            ]
        },
        {
            "id": 12,
            "tags": ["changelog_kv", "bidirectional-join"],
            "name": "changelog(table) Inner all join changelog(table)(partial primary keys join)",
            "description": "changelog(table) Inner all join changelog(table)(partial primary keys join)",
            "steps": [
                {
                    "statements": [
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_append_stream1"},
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_append_stream2"},
                        {"client":"python", "query_type": "table", "exist":"test14_append_stream1", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_append_stream1(i int, k1 int, k2 string)"},
                        {"client":"python", "query_type": "table", "exist":"test14_append_stream2", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_append_stream2(j int, kk1 int, kk2 string)"},
                        {"client":"python", "query_type": "stream", "query_id":"1412", "wait":1, "terminate":"manual", "query":"select a.i, a.k1, a.k2, b.j, b.kk1, b.kk2, _tp_delta from changelog(test14_append_stream1, k1, k2) as a inner all join changelog(test14_append_stream2, kk1, kk2) as b on a.k1 = b.kk1"},
                        {"client":"python", "query_type": "table", "depends_on":"1412", "wait":1, "query": "insert into test14_append_stream1(i, k1, k2) values (1, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream2(j, kk1, kk2) values (2, 1, 'kk')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream1(i, k1, k2) values (3, 1, 'k2')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream1(i, k1, k2) values (3, 1, 'k')"},
                        {"client":"python", "query_type": "table", "kill":"1412", "kill_wait":3, "wait":1, "query": "insert into test14_append_stream2(j, kk1, kk2) values (4, 1, 'kk')"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1412",
                    "expected_results":[
                        [1, 1, "k", 2, 1, "kk", 1],
                        [3, 1, "k2", 2, 1, "kk", 1],
                        [1, 1, "k", 2, 1, "kk", -1],
                        [3, 1, "k", 2, 1, "kk", 1],
                        [3, 1, "k2", 2, 1, "kk", -1],
                        [3, 1, "k", 2, 1, "kk", -1],
                        [3, 1, "k2", 4, 1, "kk", 1],
                        [3, 1, "k", 4, 1, "kk", 1]
                    ]
                }
            ]
        },
        {
            "id": 13,
            "tags": ["changelog", "bidirectional-join"],
            "name": "changelog(table) Inner all join changelog(table)(no primary keys join)",
            "description": "changelog(table) Inner all join changelog(table)(no primary keys join)",
            "steps": [
                {
                    "statements": [
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_append_stream1"},
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_append_stream2"},
                        {"client":"python", "query_type": "table", "exist":"test14_append_stream1", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_append_stream1(i int, k1 int, k2 string)"},
                        {"client":"python", "query_type": "table", "exist":"test14_append_stream2", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_append_stream2(j int, kk1 int, kk2 string)"},
                        {"client":"python", "query_type": "stream", "query_id":"1413", "wait":1, "terminate":"manual", "query":"select a.i, a.k1, a.k2, b.j, b.kk1, b.kk2, _tp_delta from changelog(test14_append_stream1, k1, k2) as a inner all join changelog(test14_append_stream2, kk1, kk2) as b on a.i = b.j"},
                        {"client":"python", "query_type": "table", "depends_on":"1413", "wait":1, "query": "insert into test14_append_stream1(i, k1, k2) values (1, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream2(j, kk1, kk2) values (1, 2, 'k2')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream1(i, k1, k2) values (2, 1, 'k')"},
                        {"client":"python", "query_type": "table", "kill":"1413", "kill_wait":3, "wait":1, "query": "insert into test14_append_stream2(j, kk1, kk2) values (2, 2, 'k2')"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1413",
                    "expected_results":[
                        [1, 1, "k", 1, 2, "k2", 1],
                        [1, 1, "k", 1, 2, "k2", -1],
                        [2, 1, "k", 2, 2, "k2", 1]
                    ]
                }
            ]
        },
        {
            "id": 14,
            "tags": ["versioned_kv", "bidirectional-join"],
            "name": "versioned_kv Inner all join versioned_kv(all primary keys join)",
            "description": "versioned_kv Inner all join versioned_kv(all primary keys join)",
            "steps": [
                {
                    "statements": [
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_vk_stream1"},
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_vk_stream2"},
                        {"client":"python", "query_type": "table", "exist":"test14_vk_stream1", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_vk_stream1(i int, k1 int, k2 string) primary key (k1, k2) settings mode='versioned_kv'"},
                        {"client":"python", "query_type": "table", "exist":"test14_vk_stream2", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_vk_stream2(j int, kk1 int, kk2 string) primary key (kk1,kk2) settings mode='versioned_kv'"},
                        {"client":"python", "query_type": "stream", "query_id":"1414", "wait":1, "terminate":"manual", "query":"select a.i, a.k1, a.k2, b.j, b.kk1, b.kk2, _tp_delta from test14_vk_stream1 as a inner all join test14_vk_stream2 as b on a.k1 = b.kk1 and a.k2 = b.kk2"},
                        {"client":"python", "query_type": "table", "depends_on":"1414", "wait":1, "query": "insert into test14_vk_stream1(i, k1, k2) values (1, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_vk_stream2(j, kk1, kk2) values (2, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_vk_stream1(i, k1, k2) values (3, 1, 'k')"},
                        {"client":"python", "query_type": "table", "kill":"1414", "kill_wait":3, "wait":1, "query": "insert into test14_vk_stream2(j, kk1, kk2) values (4, 1, 'k')"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1414",
                    "expected_results":[
                        [1, 1, "k", 2, 1, "k", 1],
                        [1, 1, "k", 2, 1, "k", -1],
                        [3, 1, "k", 2, 1, "k", 1],
                        [3, 1, "k", 2, 1, "k", -1],
                        [3, 1, "k", 4, 1, "k", 1]
                    ]
                }
            ]
        },
        {
            "id": 15,
            "tags": ["versioned_kv", "bidirectional-join"],
            "name": "versioned_kv Inner all join versioned_kv(partial primary keys join)",
            "description": "versioned_kv Inner all join versioned_kv(partial primary keys join)",
            "steps": [
                {
                    "statements": [
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_vk_stream1"},
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_vk_stream2"},
                        {"client":"python", "query_type": "table", "exist":"test14_vk_stream1", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_vk_stream1(i int, k1 int, k2 string) primary key (k1, k2) settings mode='versioned_kv'"},
                        {"client":"python", "query_type": "table", "exist":"test14_vk_stream2", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_vk_stream2(j int, kk1 int, kk2 string) primary key (kk1,kk2) settings mode='versioned_kv'"},
                        {"client":"python", "query_type": "stream", "query_id":"1415", "wait":1, "terminate":"manual", "query":"select a.i, a.k1, a.k2, b.j, b.kk1, b.kk2, _tp_delta from test14_vk_stream1 as a inner all join test14_vk_stream2 as b on a.k1 = b.kk1;"},
                        {"client":"python", "query_type": "table", "depends_on":"1415", "wait":1, "query": "insert into test14_vk_stream1(i, k1, k2) values (1, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_vk_stream2(j, kk1, kk2) values (2, 1, 'kk')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_vk_stream1(i, k1, k2) values (3, 1, 'k2')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_vk_stream1(i, k1, k2) values (3, 1, 'k')"},
                        {"client":"python", "query_type": "table", "kill":"1415", "kill_wait":3, "wait":1, "query": "insert into test14_vk_stream2(j, kk1, kk2) values (4, 1, 'kk')"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1415",
                    "expected_results":[
                        [1, 1, "k", 2, 1, "kk", 1],
                        [3, 1, "k2", 2, 1, "kk", 1],
                        [1, 1, "k", 2, 1, "kk", -1],
                        [3, 1, "k", 2, 1, "kk", 1],
                        [3, 1, "k2", 2, 1, "kk", -1],
                        [3, 1, "k", 2, 1, "kk", -1],
                        [3, 1, "k2", 4, 1, "kk", 1],
                        [3, 1, "k", 4, 1, "kk", 1]
                    ]
                }
            ]
        },
        {
            "id": 16,
            "tags": ["versioned_kv", "bidirectional-join"],
            "name": "versioned_kv Inner all join versioned_kv(no primary keys join)",
            "description": "versioned_kv Inner all join versioned_kv(no primary keys join)",
            "steps": [
                {
                    "statements": [
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_vk_stream1"},
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_vk_stream2"},
                        {"client":"python", "query_type": "table", "exist":"test14_vk_stream1", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_vk_stream1(i int, k1 int, k2 string) primary key (k1, k2) settings mode='versioned_kv'"},
                        {"client":"python", "query_type": "table", "exist":"test14_vk_stream2", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_vk_stream2(j int, kk1 int, kk2 string) primary key (kk1,kk2) settings mode='versioned_kv'"},
                        {"client":"python", "query_type": "stream", "query_id":"1416", "wait":1, "terminate":"manual", "query":"select a.i, a.k1, a.k2, b.j, b.kk1, b.kk2, _tp_delta from test14_vk_stream1 as a inner all join test14_vk_stream2 as b on a.i = b.j"},
                        {"client":"python", "query_type": "table", "depends_on":"1416", "wait":1, "query": "insert into test14_vk_stream1(i, k1, k2) values (1, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_vk_stream2(j, kk1, kk2) values (1, 2, 'k2')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_vk_stream1(i, k1, k2) values (2, 1, 'k')"},
                        {"client":"python", "query_type": "table", "kill":"1416", "kill_wait":3, "wait":1, "query": "insert into test14_vk_stream2(j, kk1, kk2) values (2, 2, 'k2')"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1416",
                    "expected_results":[
                        [1, 1, "k", 1, 2, "k2", 1],
                        [1, 1, "k", 1, 2, "k2", -1],
                        [2, 1, "k", 2, 2, "k2", 1]
                    ]
                }
            ]
        },
        {
            "id": 17,
            "tags": ["versioned_kv", "append-only", "Dynamic data enrichment join"],
            "name": "append-only Inner all join changelog",
            "description": "append-only Inner all join changelog",
            "steps": [
                {
                    "statements": [
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_left_stream"},
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_changelog_stream"},
                        {"client":"python", "query_type": "table", "exist":"test14_left_stream", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_left_stream (i int, k1 int, k2 string)"},
                        {"client":"python", "query_type": "table", "exist":"test14_changelog_stream", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_changelog_stream (j int, kk1 int, kk2 string) settings mode='changelog'"},
                        {"client":"python", "query_type": "stream", "query_id":"1417", "wait":1, "terminate":"manual", "query":"select a.i, a.k1, a.k2, b.j, b.kk1, b.kk2, _tp_delta from test14_left_stream as a inner all join test14_changelog_stream as b on a.k1 = b.kk1 and a.k2 = b.kk2"},
                        {"client":"python", "query_type": "table", "depends_on":"1417", "wait":1, "query": "insert into test14_left_stream(i, k1, k2) values (1, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_changelog_stream(j, kk1, kk2) values (2, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_changelog_stream(j, kk1, kk2, _tp_delta) values (2, 1, 'k', -1);"},
                        {"client":"python", "query_type": "table", "kill":"1417", "kill_wait":3, "wait":1, "query": "insert into test14_changelog_stream(j, kk1, kk2) values (4, 1, 'k')"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1417",
                    "expected_results":[
                        [1, 1, "k", 2, 1, "k", 1],
                        [1, 1, "k", 2, 1, "k", -1],
                        [1, 1, "k", 4, 1, "k", 1]
                    ]
                }
            ]
        },
        {
            "id": 18,
            "tags": ["versioned_kv", "append-only", "Dynamic data enrichment join"],
            "name": "append-only left all join changelog",
            "description": "append-only left all join changelog",
            "steps": [
                {
                    "statements": [
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_left_stream"},
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_changelog_stream"},
                        {"client":"python", "query_type": "table", "exist":"test14_left_stream", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_left_stream (i int, k1 int, k2 string)"},
                        {"client":"python", "query_type": "table", "exist":"test14_changelog_stream", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_changelog_stream (j int, kk1 int, kk2 string) settings mode='changelog'"},
                        {"client":"python", "query_type": "stream", "query_id":"1418", "wait":1, "terminate":"manual", "query":"select a.i, a.k1, a.k2, b.j, b.kk1, b.kk2, _tp_delta from test14_left_stream as a left all join test14_changelog_stream as b on a.k1 = b.kk1 and a.k2 = b.kk2"},
                        {"client":"python", "query_type": "table", "depends_on":"1418", "wait":1, "query": "insert into test14_left_stream(i, k1, k2) values (1, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_changelog_stream(j, kk1, kk2) values (2, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_changelog_stream(j, kk1, kk2, _tp_delta) values (2, 1, 'k', -1)"},
                        {"client":"python", "query_type": "table", "kill":"1418", "kill_wait":3, "wait":1, "query": "insert into test14_changelog_stream(j, kk1, kk2) values (4, 1, 'k')"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1418",
                    "expected_results":[
                        [1, 1, "k", 0, 0, "", 0],
                        [1, 1, "k", 2, 1, "k", 1],
                        [1, 1, "k", 2, 1, "k", -1],
                        [1, 1, "k", 4, 1, "k", 1]
                    ]
                }
            ]
        },
        {
            "id": 19,
            "tags": ["changelog(table)", "append-only", "Dynamic data enrichment join"],
            "name": "append-only Inner all join changelog(table)(all primary join)",
            "description": "append-only Inner all join changelog(table)(all primary join)",
            "steps": [
                {
                    "statements": [
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_append_stream1"},
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_append_stream2"},
                        {"client":"python", "query_type": "table", "exist":"test14_append_stream1", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_append_stream1 (i int, k1 int, k2 string)"},
                        {"client":"python", "query_type": "table", "exist":"test14_append_stream2", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_append_stream2 (j int, kk1 int, kk2 string)"},
                        {"client":"python", "query_type": "stream", "query_id":"1419", "wait":1, "terminate":"manual", "query":"select a.i, a.k1, a.k2, b.j, b.kk1, b.kk2, _tp_delta from test14_append_stream1 as a inner all join changelog(test14_append_stream2, kk1, kk2) as b on a.k1 = b.kk1 and a.k2 = b.kk2"},
                        {"client":"python", "query_type": "table", "depends_on":"1419", "wait":1, "query": "insert into test14_append_stream2(j, kk1, kk2) values (2, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream1(i, k1, k2) values (1, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream2(j, kk1, kk2) values (4, 1, 'k')"},
                        {"client":"python", "query_type": "table", "kill":"1419", "kill_wait":3, "wait":1, "query": "insert into test14_append_stream1(i, k1, k2) values (3, 1, 'k')"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1419",
                    "expected_results":[
                        [1, 1, "k", 2, 1, "k", 1],
                        [1, 1, "k", 2, 1, "k", -1],
                        [1, 1, "k", 4, 1, "k", 1],
                        [3, 1, "k", 4, 1, "k", 1]
                    ]
                }
            ]
        },
        {
            "id": 20,
            "tags": ["changelog(table)", "append-only", "Dynamic data enrichment join"],
            "name": "append-only Inner all join changelog(table)(partial primary join)",
            "description": "append-only Inner all join changelog(table)(partial primary join)",
            "steps": [
                {
                    "statements": [
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_append_stream1"},
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_append_stream2"},
                        {"client":"python", "query_type": "table", "exist":"test14_append_stream1", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_append_stream1 (i int, k1 int, k2 string)"},
                        {"client":"python", "query_type": "table", "exist":"test14_append_stream2", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_append_stream2 (j int, kk1 int, kk2 string)"},
                        {"client":"python", "query_type": "stream", "query_id":"1420", "wait":1, "terminate":"manual", "query":"select a.i, a.k1, a.k2, b.j, b.kk1, b.kk2, _tp_delta from test14_append_stream1 as a inner all join changelog(test14_append_stream2, kk1, kk2) as b on a.k1 = b.kk1"},
                        {"client":"python", "query_type": "table", "depends_on":"1420", "wait":1, "query": "insert into test14_append_stream2(j, kk1, kk2) values (2, 1, 'kk')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream1(i, k1, k2) values (1, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream2(j, kk1, kk2) values (4, 1, 'kk2')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream2(j, kk1, kk2) values (4, 1, 'kk')"},
                        {"client":"python", "query_type": "table", "kill":"1420", "kill_wait":3, "wait":1, "query": "insert into test14_append_stream1(i, k1, k2) values (3, 1, 'k')"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1420",
                    "expected_results":[
                        [1, 1, "k", 2, 1, "kk", 1],
                        [1, 1, "k", 4, 1, "kk2", 1],
                        [1, 1, "k", 2, 1, "kk", -1],
                        [1, 1, "k", 4, 1, "kk", 1],
                        [3, 1, "k", 4, 1, "kk2", 1],
                        [3, 1, "k", 4, 1, "kk", 1]
                    ]
                }
            ]
        },
        {
            "id": 21,
            "tags": ["changelog(table)", "append-only", "Dynamic data enrichment join"],
            "name": "append-only Inner all join changelog(table)(mo primary join)",
            "description": "append-only Inner all join changelog(table)(no primary join)",
            "steps": [
                {
                    "statements": [
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_append_stream1"},
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_append_stream2"},
                        {"client":"python", "query_type": "table", "exist":"test14_append_stream1", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_append_stream1 (i int, k1 int, k2 string)"},
                        {"client":"python", "query_type": "table", "exist":"test14_append_stream2", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_append_stream2 (j int, kk1 int, kk2 string)"},
                        {"client":"python", "query_type": "stream", "query_id":"1421", "wait":1, "terminate":"manual", "query":"select a.i, a.k1, a.k2, b.j, b.kk1, b.kk2, _tp_delta from changelog(test14_append_stream1, k1, k2) as a inner all join changelog(test14_append_stream2, kk1, kk2) as b on a.i = b.j"},
                        {"client":"python", "query_type": "table", "depends_on":"1421", "wait":1, "query": "insert into test14_append_stream1(i, k1, k2) values (1, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream2(j, kk1, kk2) values (1, 2, 'k2')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream1(i, k1, k2) values (2, 1, 'k')"},
                        {"client":"python", "query_type": "table", "kill":"1421", "kill_wait":3, "wait":1, "query": "insert into test14_append_stream2(j, kk1, kk2) values (2, 2, 'k2')"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1421",
                    "expected_results":[
                        [1, 1, "k", 1, 2, "k2", 1],
                        [1, 1, "k", 1, 2, "k2", -1],
                        [2, 1, "k", 2, 2, "k2", 1]
                    ]
                }
            ]
        },
        {
            "id": 22,
            "tags": ["changelog(table)", "append-only", "Dynamic data enrichment join"],
            "name": "append-only left all join changelog(table)(all primary join)",
            "description": "append-only left all join changelog(table)(all primary join)",
            "steps": [
                {
                    "statements": [
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_append_stream1"},
                        {"client":"python", "query_type":"table", "query":"drop stream if exists test14_append_stream2"},
                        {"client":"python", "query_type": "table", "exist":"test14_append_stream1", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_append_stream1 (i int, k1 int, k2 string)"},
                        {"client":"python", "query_type": "table", "exist":"test14_append_stream2", "exist_wait":2, "wait":1, "query":"create stream if not exists test14_append_stream2 (j int, kk1 int, kk2 string)"},
                        {"client":"python", "query_type": "stream", "query_id":"1422", "wait":1, "terminate":"manual", "query":"select a.i, a.k1, a.k2, b.j, b.kk1, b.kk2, _tp_delta from test14_append_stream1 as a left all join changelog(test14_append_stream2, kk1, kk2) as b on a.k1 = b.kk1 and a.k2 = b.kk2"},
                        {"client":"python", "query_type": "table", "depends_on":"1422", "wait":1, "query": "insert into test14_append_stream2(j, kk1, kk2) values (2, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream1(i, k1, k2) values (1, 1, 'k')"},
                        {"client":"python", "query_type": "table", "wait":1, "query": "insert into test14_append_stream2(j, kk1, kk2) values (4, 1, 'k')"},
                        {"client":"python", "query_type": "table", "kill":"1422", "kill_wait":3, "wait":1, "query": "insert into test14_append_stream1(i, k1, k2) values (3, 2, 'k')"}
                    ]
                }
            ],
            "expected_results": [
                {
                    "query_id":"1422",
                    "expected_results":[
                        [1, 1, "k", 2, 1, "k", 1],
                        [1, 1, "k", 2, 1, "k", -1],
                        [1, 1, "k", 4, 1, "k", 1],
                        [3, 2, "k", 0, 0, "", 0]
                    ]
                }
            ]
        }

    ]
}

